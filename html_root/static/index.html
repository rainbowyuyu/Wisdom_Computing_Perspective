<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="智算视界 (Wisdom Computing Perspective) - 基于 AI 视觉识别与 Manim 动态引擎的下一代数学可视化计算平台。">
    <title>智算视界 · Wisdom Computing Perspective</title>

    <link rel="icon" href="assets/智算视界_avatar.svg" type="image/png">

    <!-- 预连接字体源优化加载速度 -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    <!-- 字体与图标 -->
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500&family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- 第三方库 -->
    <!-- MathJax (用于静态公式渲染) -->
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <!-- Driver.js (用于新手引导) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/driver.js@1.0.1/dist/driver.css"/>
    <script src="https://cdn.jsdelivr.net/npm/driver.js@1.0.1/dist/driver.js.iife.js"></script>
    <!-- MathLive (用于可视化公式编辑) -->
    <script defer src="//unpkg.com/mathlive"></script>
    <!-- Marked (Markdown 解析) -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- Highlight.js (代码高亮) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

    <!-- 核心样式 -->
    <link rel="stylesheet" href="css/main.css">
</head>
<body>

    <!-- 导航栏 -->
    <nav class="navbar">
        <div class="logo">
            <img src="assets/智算视界_avatar.svg" alt="icon" width="80"> 智算视界
        </div>

        <!-- 桌面端导航链接 (添加 desktop-nav 类) -->
        <div class="nav-links desktop-nav">
            <button class="nav-btn active" onclick="showSection('home')">首页</button>
            <button class="nav-btn" onclick="showSection('detect')">智能识别</button>
            <button class="nav-btn" onclick="showSection('my-formulas')">我的算式</button>
            <button class="nav-btn" onclick="showSection('calculate')">动态计算</button>
            <button class="nav-btn" onclick="showSection('examples')">教学案例</button>
            <button class="nav-btn" onclick="showSection('devtools')">开发者工具</button>
            <button class="nav-btn" onclick="showSection('help')">帮助</button>
            <button class="nav-btn" onclick="openSettings()" title="系统设置"><i class="fa-solid fa-gear"></i></button>
        </div>

        <!-- 移动端汉堡按钮 (新增) -->
        <button class="mobile-menu-btn" onclick="toggleMobileMenu()">
            <i class="fa-solid fa-bars"></i>
        </button>

        <div class="auth-buttons desktop-auth">
            <button class="login-btn" onclick="toggleAuthModal(true)">登录 / 注册</button>
            <!-- 关键修复：确保这里有 id="username-span" -->
            <span id="user-display" style="display:none; color:var(--text-main); font-weight:600;">
                <i class="fa-regular fa-user-circle"></i> <span id="username-span"></span>
                <i class="fa-solid fa-arrow-right-from-bracket" style="cursor:pointer; margin-left:10px; color:var(--text-secondary);" onclick="logout()" title="退出"></i>
            </span>
        </div>
    </nav>

    <!-- 移动端全屏菜单 (新增) -->
    <div id="mobile-menu-overlay" class="mobile-menu-overlay">
        <div class="mobile-menu-content">
            <span class="close-mobile-menu" onclick="toggleMobileMenu()">&times;</span>

            <div class="mobile-nav-links">
                <button onclick="mobileNavClick('home')">首页</button>
                <button onclick="mobileNavClick('detect')">智能识别</button>
                <button onclick="mobileNavClick('my-formulas')">我的算式</button>
                <button onclick="mobileNavClick('calculate')">动态计算</button>
                <button onclick="mobileNavClick('examples')">教学案例</button>
                <button onclick="mobileNavClick('help')">帮助</button>
                <button onclick="openSettings(); toggleMobileMenu();">系统设置</button>
            </div>

            <div class="mobile-auth-section">
                <!-- 这里的内容可以通过 JS 动态同步 -->
                <button class="login-btn full-width" onclick="toggleAuthModal(true); toggleMobileMenu();">登录 / 注册</button>
            </div>
        </div>
    </div>

    <!-- 主要内容区域 -->
    <main class="container">

        <!-- 1. 首页 Section -->
        <section id="home" class="section active-section">
            <!-- 背景装饰 (流光效果) -->
            <div class="hero-decoration">
                <div class="blob blob-1"></div>
                <div class="blob blob-2"></div>
            </div>

            <div class="hero">

                <h1 class="animate-text">
                    让数学计算<br>
                    <span class="text-gradient">看得见、摸得着</span>
                </h1>

                <p class="subtitle">
                    融合 <b>OCR</b> 手写识别 <b>Manim</b> 动态引擎。<br>
                    将枯燥的公式转化为直观的视觉语言，专为新一代学习者打造。
                </p>

                <div class="hero-btns">
                    <button class="cta-btn primary" onclick="showSection('detect')">
                        立即体验 <i class="fa-solid fa-arrow-right"></i>
                    </button>
                    <button class="cta-btn secondary" onclick="showSection('examples')">
                        <i class="fa-solid fa-play"></i> 观看演示
                    </button>
                </div>

                <!-- 新手引导入口 -->
                <div class="tutorial-link" onclick="startTutorial()">
                    <i class="fa-regular fa-circle-question"></i>
                    <span>不知道怎么用？查看 30 秒教程</span>
                </div>
            </div>

            <div class="features-grid">
                <div class="feature-card" onclick="showSection('detect')">
                    <div class="feature-icon-box">
                        <i class="fa-solid fa-eye"></i>
                    </div>
                    <h3>视觉识别</h3>
                    <p>支持手写公式与图片上传，毫秒级精准转换 LaTeX 代码，复杂矩阵也能一键提取。</p>
                </div>
                <div class="feature-card" onclick="showSection('calculate')">
                    <div class="feature-icon-box">
                        <i class="fa-solid fa-wand-magic-sparkles"></i>
                    </div>
                    <h3>动态推演</h3>
                    <p>拒绝死板的答案。基于 Python Manim 引擎，实时渲染矩阵变换、行列式展开过程。</p>
                </div>
                <div class="feature-card" onclick="showSection('examples')">
                    <div class="feature-icon-box">
                        <i class="fa-solid fa-laptop-code"></i>
                    </div>
                    <h3>交互学习</h3>
                    <p>不仅仅是计算器。支持实时修改公式参数，通过可视化过程深入理解底层数学逻辑。</p>
                </div>
            </div>
        </section>

        <!-- 2. 识别与画板 Section (重构版布局) -->
        <section id="detect" class="section">
            <h2 class="section-title" style="margin: 1.5rem 0 1rem; font-size:1.8rem;">智能算式识别</h2>

            <div class="workspace">

                <!-- 1. 左侧：纯工具栏 -->
                <div class="tools-panel">
                    <div class="tab-switch">
                        <button class="tab-btn active" onclick="switchInputMode('draw')">✍️ 手写</button>
                        <button class="tab-btn" onclick="switchInputMode('upload')">📤 上传</button>
                    </div>

                    <div id="draw-tools">
                        <div class="control-group">
                            <label>绘图工具</label>
                            <div class="tools-grid">
                                <button class="tool-btn active" onclick="setTool('pen')" title="画笔"><i class="fa-solid fa-pen"></i></button>
                                <button class="tool-btn" onclick="setTool('eraser')" title="橡皮擦"><i class="fa-solid fa-eraser"></i></button>
                                <button class="tool-btn" onclick="undo()" title="撤销 (Ctrl+Z)"><i class="fa-solid fa-rotate-left"></i></button>
                                <button class="tool-btn" onclick="redo()" title="重做 (Ctrl+Shift+Z)"><i class="fa-solid fa-rotate-right"></i></button>
                                <button class="tool-btn" onclick="clearCanvas()" title="清空" style="color:#ef4444;"><i class="fa-solid fa-trash"></i></button>
                            </div>

                            <button class="tutorial-link" onclick="openSettings()" title="画板快捷键设置">想要更高效率？点击设置快捷键</button>
                            <div style="margin-top: 20px; display: flex; align-items: center; gap: 10px;">
                                <label style="margin:0; min-width:40px; font-size:0.8rem;">粗细</label>
                                <input type="range" id="brush-size" min="1" max="20" value="3" style="flex:1;">
                            </div>
                        </div>
                    </div>

                    <div id="upload-tools" style="display:none;">
                        <label for="image-upload" class="upload-label">
                            <i class="fa-solid fa-cloud-arrow-up upload-icon"></i>
                            <span class="upload-text">点击或拖拽图片到此处</span>
                            <span class="upload-text">或直接粘贴剪贴板图片</span>
                            <!-- 将 input 放在 label 内部，id 必须对应 -->
                            <input type="file" id="image-upload" accept="image/*">
                        </label>
                        <div id="file-name-display" class="file-name"></div>
                    </div>

                    <div style="margin-top: auto;">
                        <button class="action-btn full-width" onclick="processRecognition()" style="height: 50px; font-size: 1.1rem;">
                            <i class="fa-solid fa-magnifying-glass"></i> 立即识别
                        </button>
                        <p style="text-align: center; color: var(--text-secondary); font-size: 0.8rem; margin-top: 10px;">
                            识别结果将显示在右侧底部
                        </p>
                    </div>
                </div>

                <!-- 2. 右侧：主工作区 (Canvas + Result) -->
                <div class="workspace-main">

                    <!-- 上半部分：画板 -->
                    <div class="canvas-wrapper">
                        <div id="canvas-container">
                            <canvas id="drawing-board"></canvas>

                            <!-- 确保预览图在这里，且默认隐藏 -->
                            <img id="uploaded-preview" src="" alt="预览" style="display:none;">
                        </div>
                        <!-- 提示浮层 -->
                        <div style="position: absolute; top: 15px; left: 50%; transform: translateX(-50%); background: rgba(255,255,255,0.9); padding: 6px 16px; border-radius: 20px; color: var(--text-secondary); font-size: 0.85rem; pointer-events: none; border: 1px solid #e2e8f0; box-shadow: var(--shadow-sm);">
                            <i class="fa-solid fa-info-circle"></i> 在此区域绘制公式
                        </div>
                    </div>

                    <!-- 下半部分：识别结果 (独立面板) -->
                    <div class="result-panel">
                        <div class="result-header">
                            <div class="result-title">
                                <i class="fa-solid fa-code"></i> 识别结果
                            </div>
                            <!-- 高级选项：代码折叠 -->
                            <details style="position: relative;">
                                <summary style="font-size:0.85rem; color:var(--text-secondary); cursor:pointer;">
                                    <i class="fa-solid fa-terminal"></i> 查看源码
                                </summary>
                                <div style="position: absolute; bottom: 100%; right: 0; width: 300px; background: white; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px; box-shadow: var(--shadow-lg); z-index: 20;">
                                    <textarea id="latex-code-detect" placeholder="LaTeX 代码..." style="width:100%; height:100px; font-family:monospace;"></textarea>
                                </div>
                            </details>
                        </div>

                        <div class="math-field-container">
                            <!-- MathLive 组件 -->
                            <math-field id="latex-output" virtual-keyboard-mode="manual">
                                \text{等待识别...}
                            </math-field>
                        </div>

                        <div class="result-actions">
                            <div style="font-size: 0.85rem; color: var(--text-secondary);">
                                <i class="fa-regular fa-keyboard"></i> 点击公式可直接修改
                            </div>

                            <div style="display: flex; gap: 10px;">
                                <!-- 修改 1: 添加 id="btn-save-check" 和 disabled -->
                                <button id="btn-save-check" class="btn-calc-go" onclick="saveAndShowFormula()" disabled
                                        style="background: linear-gradient(135deg, #10b981, #059669); box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);">
                                    <i class="fa-regular fa-floppy-disk"></i> 保存并查看
                                </button>

                                <!-- 修改 2: 添加 id="btn-copy-calc" 和 disabled -->
                                <button id="btn-copy-calc" class="action-btn secondary" onclick="copyToCalc()" disabled
                                        style="padding: 0.8rem 1.5rem; border-radius: 99px;" title="仅跳转到计算页，不保存">
                                    去计算 <i class="fa-solid fa-arrow-right"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </section>

        <!-- 3. 新增“我的算式”页面 (插在 Calculate Section 之后) -->
        <section id="my-formulas" class="section">
            <h2 class="section-title">我的算式库</h2>
            <div class="container" style="max-width: 1000px;">
                <div class="glass-panel" style="min-height: 500px;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
                        <h3 style="margin:0; color:var(--text-main);">已保存的公式</h3>
                        <button class="action-btn secondary" onclick="loadMyFormulas()">
                            <i class="fa-solid fa-rotate"></i> 刷新列表
                        </button>
                    </div>

                    <div id="formula-list" class="formula-grid">
                        <!-- JS 动态填充 -->
                        <div style="text-align:center; color:var(--text-secondary); padding:2rem;">
                            <i class="fa-solid fa-spinner fa-spin"></i> 加载中...
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- 3. 动态计算 Section -->
        <!-- 4. 动态计算 Section (核心重构：支持分屏与Tab切换) -->
        <section id="calculate" class="section">
            <h2 class="section-title">数学运算可视化</h2>
            <div class="calc-layout">
                <!-- 左侧配置区 -->
                <div class="calc-sidebar glass-panel">
                    <div style="margin-bottom: 1.5rem;">
                        <label style="font-weight:700; display:block; margin-bottom:0.8rem; color:var(--text-main); font-size:0.95rem;">
                            <i class="fa-solid fa-layer-group" style="color:var(--primary-color); margin-right:5px;"></i>
                            演示模式
                        </label>
                        <select id="calc-method" class="tech-select">
                            <option value="normal">通用公式推演+可视化 (推荐)</option>
                            <option value="formular">公式推演</option>
                            <option value="visualization">可视化演示</option>
                            <option value="det" disabled>矩阵专项</option>
                            <option value="int" disabled>微积分专项</option>
                        </select>
                        <p style="font-size:0.8rem; color:var(--text-secondary); margin-top:5px;">
                            * "通用模式"下，将自动分析您输入的算式并生成对应动画。
                        </p>
                    </div>

                    <!-- 核心：单一大公式输入区 -->
                    <div class="formula-input-wrapper">
                        <div class="input-header">
                            <label><i class="fa-solid fa-calculator"></i> 数学表达式</label>
                            <div class="header-actions">
                                <button class="btn-import" onclick="openFormulaSelector('A')" title="从库中导入">
                                    <i class="fa-solid fa-book-bookmark"></i> 导入
                                </button>
                                <button class="btn-import" onclick="clearCalcInput()" title="清空" style="color:#ef4444; border-color:#fee2e2;">
                                    <i class="fa-solid fa-trash"></i>
                                </button>
                            </div>
                        </div>

                        <!-- MathLive 可视化编辑 -->
                        <div class="math-field-container main-input">
                            <math-field id="math-field-main" virtual-keyboard-mode="manual" placeholder="在此输入公式，例如 \sin(x) = \frac{1}{2}">
                                \sin(x) = \frac{1}{2}
                            </math-field>
                        </div>

                        <!-- 代码折叠区 -->
                        <details class="code-details">
                            <summary>
                                <span><i class="fa-solid fa-code"></i> 编辑 LaTeX 源码</span>
                            </summary>
                            <textarea id="latex-code-main" placeholder="\int_{0}^{1} ..."></textarea>
                        </details>
                    </div>

                    <!-- 底部操作按钮 -->
                    <div style="margin-top: auto; padding-top: 1rem;">
                        <button class="action-btn full-width" onclick="startAnimation()" style="height: 54px; font-size: 1.1rem; display: flex; justify-content: center; align-items: center; gap: 10px;">
                            <i class="fa-solid fa-clapperboard"></i> 生成可视化动画
                        </button>
                    </div>
                </div>

                <!-- 右侧显示区 (重构：分屏布局) -->
                <div class="calc-display glass-panel" style="display: flex; flex-direction: column; overflow: hidden; padding: 0;">

                    <!-- 1. 顶部：视频切换选项卡 (JS动态控制显示) -->
                    <div id="video-tabs" style="display: none; background: #0f172a; border-bottom: 1px solid #334155; padding: 0 10px;">
                        <!-- JS 注入 -->
                    </div>

                    <!-- 2. 上半部分：视频播放区 -->
                    <div id="calc-video-wrapper" style="flex: 3; background: #000; position: relative; display: flex; align-items: center; justify-content: center; border-bottom: 1px solid #334155; min-height: 300px;">
                        <!-- 默认占位符 -->
                        <div id="video-placeholder-content" style="text-align: center; color: #64748b;">
                            <i class="fa-solid fa-cube" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                            <p style="font-weight: 500;">等待指令...</p>
                            <span style="font-size:0.85rem; opacity:0.6;">配置左侧参数后点击生成</span>
                        </div>
                        <!-- 视频播放器 (初始隐藏) -->
                        <video id="result-video-player" controls style="width: 100%; height: 100%; display: none; outline: none;">
                            <source src="" type="video/mp4">
                            您的浏览器不支持视频标签。
                        </video>
                    </div>

                    <!-- 3. 下半部分：代码/日志控制台 -->
                    <div id="calc-terminal-wrapper" style="flex: 2; background: #0f172a; display: flex; flex-direction: column; min-height: 200px;">
                        <!-- 头部 -->
                        <div style="padding: 8px 15px; background: #1e293b; border-bottom: 1px solid #334155; display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-family: 'JetBrains Mono'; font-size: 0.8rem; color: #94a3b8;">
                                <i class="fa-solid fa-terminal"></i> <span id="console-title">系统日志</span>
                            </span>
                            <span id="gen-percent" style="font-family: 'JetBrains Mono'; font-size: 0.8rem; color: #34d399;">0%</span>
                        </div>
                        <!-- 进度条 -->
                        <div style="height: 2px; background: #334155; width: 100%;">
                            <div id="gen-progress" style="width: 0%; height: 100%; background: #3b82f6; transition: width 0.3s;"></div>
                        </div>
                        <!-- 日志内容 -->
                        <div id="gen-log" style="flex: 1; overflow-y: auto; padding: 15px; font-family: 'JetBrains Mono', monospace; font-size: 0.85rem; color: #cbd5e1;">
                            <div class="log-entry" style="color: #64748b;">> 系统就绪，等待输入...</div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- 4. 教学案例 Section -->
        <section id="examples" class="section">
            <h2 class="section-title">精选教学案例</h2>
            <!-- ID 改为 examples-grid -->
            <div id="examples-grid" class="video-grid">
                <!-- JS 动态加载 -->
            </div>
        </section>


        <!-- 开发者工具 Section (完全替换原有代码) -->
        <section id="devtools" class="section">
            <h2 class="section-title">代码开发者工作台</h2>

            <div class="workspace">
                <!-- 左侧导航 -->
                <div class="tools-panel" style="flex: 0 0 240px;">
                    <div class="control-group">
                        <label>工具箱</label>
                        <div class="tools-list">
                            <button class="tab-btn active" onclick="switchDevTool('latex')">
                                <i class="fa-solid fa-square-root-variable"></i> LaTeX 可视化编辑器
                            </button>
                            <button class="tab-btn" onclick="switchDevTool('manim')">
                                <i class="fa-brands fa-python"></i> Manim 代码云端渲染工作台
                            </button>
                        </div>
                    </div>

                    <div class="control-group" style="margin-top: auto;">
                        <label>快捷键</label>
                        <div style="font-size: 0.8rem; color: var(--text-secondary); line-height: 1.6;">
                            <p><kbd>Ctrl</kbd> + <kbd>Enter</kbd> 运行代码</p>
                            <p><kbd>Tab</kbd> 自动补全 (Beta)</p>
                        </div>
                    </div>
                </div>

                <!-- 右侧工作区 -->
                <div class="workspace-main">

                    <!-- 1. LaTeX 编辑器 -->
                    <div id="dev-latex" class="dev-panel">
                        <div class="dev-split-view">
                            <!-- 输入区 (MathLive) -->
                            <div class="dev-col">
                                <div class="dev-label">
                                    <span><i class="fa-solid fa-keyboard"></i> 可视化输入</span>
                                    <span style="font-size:0.7rem; opacity:0.7;">MathLive Engine</span>
                                </div>
                                <div style="flex:1; display:flex; align-items:center;">
                                    <math-field id="dev-latex-mathfield" virtual-keyboard-mode="manual">
                                        x = \frac{-b \pm \sqrt{b^2 - 4ac}}{2a}
                                    </math-field>
                                </div>
                            </div>

                            <!-- 源码预览区 -->
                            <div class="dev-col">
                                <div class="dev-label">
                                    <span><i class="fa-solid fa-code"></i> LaTeX 源码</span>
                                    <button class="action-btn secondary" style="padding: 2px 8px; font-size:0.7rem;" onclick="copyDevLatex()">
                                        <i class="fa-regular fa-copy"></i> 复制
                                    </button>
                                </div>
                                <textarea id="dev-latex-source" class="tech-input" style="flex:1; margin:0; font-family:monospace; resize:none;" readonly></textarea>
                            </div>
                        </div>

                        <!-- 底部渲染预览 (MathJax) -->
                        <div class="dev-col" style="flex: 0 0 150px;">
                            <div class="dev-label">
                                <span><i class="fa-solid fa-eye"></i> 最终渲染预览</span>
                            </div>
                            <div id="dev-latex-preview"></div>
                        </div>
                    </div>

                    <!-- 2. Manim 工作台 -->
                    <div id="dev-manim" class="dev-panel" style="display: none; padding: 0;">
                        <div class="ide-layout">
                            <!-- 代码编辑器 -->
                            <div class="ide-editor">
                                <div class="ide-toolbar">
                                    <span><i class="fa-brands fa-python"></i> main.py</span>
                                    <button id="btn-run-manim" class="ide-btn-run" onclick="runDevManim()">
                                        <i class="fa-solid fa-play"></i> 运行脚本
                                    </button>
                                </div>

                                <div class="code-wrapper">
                                    <!-- 高亮层：移除 language-python 类，交给 innerHTML 处理，保持干净 -->
                                    <pre id="dev-manim-highlight" class="code-layer"></pre>

                                    <!-- 输入层 -->
                                    <textarea id="dev-manim-input" class="code-layer" spellcheck="false"></textarea>
                                </div>
                            </div>

                            <!-- 视频预览 -->
                            <div class="ide-preview">
                                <video id="dev-manim-video" controls style="width:100%; height:100%; display:none; object-fit:contain;"></video>

                                <div id="dev-manim-placeholder" class="ide-placeholder">
                                    <i class="fa-solid fa-clapperboard" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                                    <p>编写代码并点击运行<br>预览将在此处显示</p>
                                </div>

                                <div id="dev-manim-loading" class="ide-loading" style="display: none;">
                                    <i class="fa-solid fa-circle-notch fa-spin" style="font-size: 2rem; color: #4caf50;"></i>
                                    <p style="margin-top: 10px; font-size: 0.9rem;">正在云端渲染...</p>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </section>

        <!-- 5. 帮助 Section -->
        <section id="help" class="section">
            <h2 class="section-title">常见问题与指南</h2>
            <div class="help-container" style="max-width:800px; margin:0 auto;">

                <!-- 新增：再次观看教程的入口 Banner -->
                <div class="tutorial-banner" onclick="startTutorial()">
                    <div class="banner-icon">
                        <i class="fa-solid fa-graduation-cap"></i>
                    </div>
                    <div class="banner-content">
                        <h3>新手入门指南</h3>
                        <p>错过引导了？点击这里重新开启交互式教学，30秒掌握所有核心功能。</p>
                    </div>
                    <div class="banner-action">
                        <i class="fa-solid fa-circle-play"></i> 观看
                    </div>
                </div>



                <!-- 1. 识别与输入 -->
                <details open>
                    <summary>系统支持哪些手写格式和数学内容？</summary>
                    <p>目前系统针对<b>线性代数</b>进行了深度优化。
                    <br>✅ <b>完美支持：</b> 矩阵（方阵、列向量、稀疏矩阵）、行列式、基础代数运算（加减乘除）。
                    <br>⚠️ <b>正在训练：</b> 复杂的微积分符号（积分、极限）目前仅支持识别，暂不支持动画生成。
                    <br>💡 <b>建议：</b> 书写时请尽量保持字符间距，避免连笔；使用黑色或深蓝色墨水在白纸上书写效果最佳。</p>
                </details>

                <details>
                    <summary>识别结果不准确怎么办？</summary>
                    <p>AI 识别可能受光线、角度或字迹潦草程度影响。如果识别有误，您无需重新上传，可以直接使用我们内置的<b>双向编辑功能</b>：
                    <br>1. <b>可视化修改：</b> 直接点击“识别结果”区域的公式，像在 Word 中一样修改数字。
                    <br>2. <b>代码修改：</b> 点击右上角的“查看源码”，直接修改 LaTeX 代码，结果会实时同步。</p>
                </details>

                <details>
                    <summary>上传图片有什么要求？</summary>
                    <p>支持 JPG, PNG 格式。建议图片清晰、光线均匀、无阴影遮挡。尽量让公式位于图片中心，且背景干净（避免复杂的格纹或背景图案干扰 AI 识别）。</p>
                </details>

                <!-- 2. 计算与动画 -->
                <details>
                    <summary>为什么生成的动画报错或无法播放？</summary>
                    <p>通常是因为数学逻辑错误导致的。请检查：
                    <br>1. <b>矩阵维度：</b> 进行矩阵乘法 (A × B) 时，A 的列数必须等于 B 的行数。
                    <br>2. <b>行列式：</b> 只有方阵（行数=列数）才能计算行列式。
                    <br>3. <b>语法错误：</b> 如果是手动输入的 LaTeX，请确保语法闭合（如 `\begin{bmatrix}` 必须有 `\end{bmatrix}`）。</p>
                </details>

                <details>
                    <summary>渲染动画需要多久？生成的视频可以下载吗？</summary>
                    <p>简单通用算法通常在 <b>30-50 秒</b>内完成。复杂的算法如复杂的微积分矩阵的推演和可视化可能需要 <b>100-150 秒</b>，如果超过 <b>180秒</b> 由于服务器算力限制暂时会判定为timeout，请简化算式。
                    <br>动画生成后，您可以点击视频播放器右下角的“三个点”图标选择<b>“下载”</b>，或右键点击视频选择“视频另存为”，将其保存到本地用于PPT演示或教学。</p>
                </details>

                <!-- 3. 功能与账号 -->
                <details>
                    <summary>“我的算式”功能怎么用？</summary>
                    <p>这是您的云端笔记本。
                    <br>1. <b>保存：</b> 在识别或编辑完公式后，点击“保存并查看”，该公式就会存入云端。
                    <br>2. <b>复用：</b> 在“动态计算”页面，点击输入框上方的<b>“导入”</b>按钮，可以直接从库中选择公式填入，无需重复输入。</p>
                </details>

                <details>
                    <summary>关于数据隐私与安全</summary>
                    <p>我们非常重视您的隐私。
                    <br>1. 您上传的用于识别的图片<b>不会</b>被永久存储，处理完成后会定期清除。
                    <br>2. 您保存到“我的算式”中的公式数据存储在加密数据库中，仅您自己可见。</p>
                </details>

                <details>
                    <summary>是否收费？</summary>
                    <p><b>智算视界 (Wisdom Computing Perspective)</b> 目前是一个开源教育驱动的项目。基础功能（OCR 识别、标准清晰度 Manim 渲染、云端存储）对所有注册用户目前是<b>免费</b>的。</p>
                </details>

                <!-- 底部联系方式 -->
                <div style="margin-top: 3rem; text-align: center; color: var(--text-secondary); font-size: 0.9rem;">
                    <p>没找到您需要的答案？</p>
                    <p>欢迎发送邮件至 <a href="mailto:rainbowyu619@gmail.com" target="_blank" style="color: var(--primary-color); text-decoration: none; font-weight: 600;">rainbowyu619@gmail.com</a> 联系技术团队。</p>
                </div>
            </div>
        </section>

    </main>

    <!-- 登录/注册 模态框 -->
    <div id="auth-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="toggleAuthModal(false)">&times;</span>

            <div class="auth-tabs">
                <div class="auth-tab active" onclick="switchAuthMode('login')">登录</div>
                <div class="auth-tab" onclick="switchAuthMode('register')">注册</div>
            </div>

            <div class="auth-body">
                <!-- 登录表单 -->
                <form id="login-form">
                    <input type="text" placeholder="用户名" class="tech-input" id="login-user">
                    <input type="password" placeholder="密码" class="tech-input" id="login-pass">

                    <div class="captcha-row">
                        <input type="text" placeholder="验证码" class="tech-input" id="login-captcha">
                        <img id="captcha-img-login" src="" alt="点击刷新" class="captcha-img" onclick="refreshCaptcha('login')" title="点击刷新验证码">
                    </div>

                    <!-- 新增：隐私协议勾选 -->
                    <div style="margin-bottom: 1.5rem; display: flex; align-items: start; gap: 8px; font-size: 0.85rem; color: var(--text-secondary);">
                        <input type="checkbox" id="login-agree" style="margin-top: 3px;">
                        <label for="login-agree" style="cursor: pointer; user-select: none;">
                            我已阅读并同意
                            <a href="javascript:void(0)" onclick="openDoc('terms.md', '服务协议')" style="color: var(--primary-color);">服务协议</a> 与
                            <a href="javascript:void(0)" onclick="openDoc('privacy.md', '隐私政策')" style="color: var(--primary-color);">隐私政策</a>
                        </label>
                    </div>

                    <button type="button" id="btn-login-submit" class="action-btn full-width" onclick="handleLogin()">立即登录</button>
                </form>

                <!-- 注册表单 -->
                <form id="register-form" style="display:none;">
                    <input type="text" placeholder="设置用户名" class="tech-input" id="reg-user">
                    <input type="password" placeholder="设置密码" class="tech-input" id="reg-pass">

                    <!-- 新增：确认密码 -->
                    <input type="password" placeholder="确认密码" class="tech-input" id="reg-pass-confirm">

                    <div class="captcha-row">
                        <input type="text" placeholder="验证码" class="tech-input" id="reg-captcha">
                        <img id="captcha-img-reg" src="" alt="点击刷新" class="captcha-img" onclick="refreshCaptcha('register')" title="点击刷新验证码">
                    </div>

                    <!-- 新增：隐私协议勾选 -->
                    <div style="margin-bottom: 1.5rem; display: flex; align-items: start; gap: 8px; font-size: 0.85rem; color: var(--text-secondary);">
                        <input type="checkbox" id="reg-agree" style="margin-top: 3px;">
                        <label for="reg-agree" style="cursor: pointer; user-select: none;">
                            我已阅读并同意
                            <a href="javascript:void(0)" onclick="openDoc('terms.md', '服务协议')" style="color: var(--primary-color);">服务协议</a> 与
                            <a href="javascript:void(0)" onclick="openDoc('privacy.md', '隐私政策')" style="color: var(--primary-color);">隐私政策</a>
                        </label>
                    </div>

                    <button type="button" id="btn-reg-submit" class="action-btn full-width" onclick="handleRegister()">注册账户</button>
                </form>
            </div>
        </div>
    </div>

    <!-- index.html Settings Modal 部分 -->

    <div id="settings-modal" class="modal">
        <div class="modal-content glass-panel" style="width: 500px;">
            <span class="close-modal" onclick="closeSettings()">&times;</span>
            <h3 style="padding: 1.5rem 2rem 0; color: var(--text-main);">系统设置</h3>

            <div style="padding: 2rem;">

                <!-- 新增：基本信息 -->
                <div style="margin-bottom: 2rem;">
                    <h4 style="margin-bottom: 1rem; color: var(--text-secondary); border-bottom: 1px solid #eee; padding-bottom: 0.5rem;">基本信息</h4>
                    <div style="display: flex; justify-content: space-between; align-items: center; color: var(--text-main); font-size: 0.95rem;">
                        <span>当前版本</span>
                        <span
                          id="version-display"
                          onclick="openDoc('update.md', '更新日志')"
                          title="点击查看更新日志"
                          style="
                            font-family: 'JetBrains Mono', monospace;
                            background: #eff6ff;
                            color: var(--primary-color);
                            padding: 2px 8px;
                            border-radius: 4px;
                            cursor: pointer;
                            user-select: none;
                          ">
                          Loading...
                        </span>

                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; color: var(--text-main); font-size: 0.95rem; margin-top: 10px;">
                        <span>开发者</span>
                        <span
                            onclick="window.open('https://github.com/rainbowyuyu', '_blank')"
                            style="
                                font-family: 'JetBrains Mono', monospace;
                                background: #eff6ff;
                                color: var(--primary-color);
                                padding: 2px 8px;
                                border-radius: 4px;
                                cursor: pointer;
                                user-select: none;
                            "
                        >
                            rainbow_yu
                        </span>
                    </div>

                    <div style="display: flex; justify-content: space-between; align-items: center; color: var(--text-main); font-size: 0.95rem; margin-top: 10px;">
                        <span>深色模式</span>
                        <button class="nav-btn" onclick="toggleTheme()" title="切换模式">
                            <i id="theme-toggle-icon" class="fa-solid fa-moon"></i>
                        </button>
                    </div>
                </div>


                <div style="margin-bottom: 2rem;">
                    <h4 style="margin-bottom: 1rem; color: var(--text-secondary); border-bottom: 1px solid #eee; padding-bottom: 0.5rem;">快捷键设置（画板）</h4>

                    <div style="display: flex; align-items: center; margin-bottom: 1rem; gap: 10px;">
                        <label style="width: 80px; font-weight: 600;">撤销</label>
                        <input type="text" id="shortcut-undo-display" class="tech-input" readonly style="margin:0; text-align: center;">
                        <button id="btn-record-undo" class="action-btn secondary" style="padding: 0.5rem 1rem;" onclick="startRecording('undo')">修改</button>
                    </div>

                    <div style="display: flex; align-items: center; gap: 10px;">
                        <label style="width: 80px; font-weight: 600;">重做</label>
                        <input type="text" id="shortcut-redo-display" class="tech-input" readonly style="margin:0; text-align: center;">
                        <button id="btn-record-redo" class="action-btn secondary" style="padding: 0.5rem 1rem;" onclick="startRecording('redo')">修改</button>
                    </div>
                </div>

                <div style="text-align: right; border-top: 1px solid #eee; padding-top: 1.5rem;">
                    <button class="action-btn" onclick="resetDefaults()" style="background: #ef4444; border:none; color:white; font-size:0.9rem;">恢复默认设置</button>
                    <button class="action-btn" onclick="closeSettings()" style="margin-left: 10px;">完成</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 编辑算式 Modal -->
    <!-- index.html (找到 id="edit-formula-modal" 的部分并替换) -->

    <!-- 编辑算式 Modal -->
    <div id="edit-formula-modal" class="modal">
        <div class="modal-content glass-panel" style="width: 600px;"> <!-- 加宽一点 -->
            <span class="close-modal" onclick="closeEditModal()">&times;</span>
            <h3 style="padding: 1.5rem 2rem 0; color: var(--text-main);">编辑算式</h3>

            <div style="padding: 2rem;">
                <input type="hidden" id="edit-formula-id">

                <div style="margin-bottom: 1.5rem;">
                    <label style="display:block; margin-bottom:8px; font-weight:600; color:var(--text-main); font-size:0.9rem;">备注名称</label>
                    <input type="text" id="edit-formula-note" class="tech-input" placeholder="例如：矩阵A">
                </div>

                <div style="margin-bottom: 1.5rem;">
                    <label style="display:block; margin-bottom:8px; font-weight:600; color:var(--text-main); font-size:0.9rem;">公式内容</label>

                    <!-- 可视化编辑器 -->
                    <div class="math-field-container" style="border: 1px solid #cbd5e1; border-radius: 8px; background: #f8fafc; padding: 0.5rem; margin-bottom: 10px;">
                        <math-field id="edit-formula-mathlive" virtual-keyboard-mode="manual" style="width: 100%; font-size: 1.4rem; padding: 0.5rem; background: transparent; border: none; outline: none;">
                            <!-- 动态填充 -->
                        </math-field>
                    </div>

                    <!-- 代码编辑器 (折叠) -->
                    <details>
                        <summary style="font-size:0.85rem; color:var(--text-secondary); cursor:pointer;">
                            <i class="fa-solid fa-code"></i> 编辑 LaTeX 源代码
                        </summary>
                        <textarea id="edit-formula-latex" class="tech-input" style="height:80px; font-family:monospace; margin-top:5px;"></textarea>
                    </details>
                </div>

                <div style="text-align: right;">
                    <button class="action-btn secondary" onclick="closeEditModal()" style="margin-right: 10px;">取消</button>
                    <button class="action-btn" onclick="submitFormulaEdit()">保存修改</button>
                </div>
            </div>
        </div>
    </div>

    <div id="select-formula-modal" class="modal">
        <div class="modal-content glass-panel" style="width: 600px; max-height: 80vh; display:flex; flex-direction:column;">
            <div style="padding: 1.5rem 2rem; border-bottom:1px solid #e2e8f0; display:flex; justify-content:space-between; align-items:center;">
                <h3 style="margin:0; color: var(--text-main);">选择公式</h3>
                <span class="close-modal" onclick="closeFormulaSelector()" style="position:static;">&times;</span>
            </div>

            <div id="selector-list" style="padding: 2rem; overflow-y:auto; flex:1; background:#f8fafc;">
                <!-- 动态填充 -->
                <div style="text-align:center;"><i class="fa-solid fa-spinner fa-spin"></i> 加载中...</div>
            </div>
        </div>
    </div>

    <!-- 通用文档模态框 -->
    <div id="docs-modal" class="modal">
        <!-- 移除内联样式，使用 CSS 控制 -->
        <div class="modal-content glass-panel">

            <!-- 头部 -->
            <div class="docs-header">
                <h3 id="docs-title">文档标题</h3>
                <span class="close-modal" onclick="closeDocsModal()">&times;</span>
            </div>

            <!-- 内容区域 -->
            <div id="docs-content" class="markdown-body">
                <div class="docs-loading-placeholder">
                    <i class="fa-solid fa-spinner fa-spin" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                    <span>加载中...</span>
                </div>
            </div>

            <!-- 底部 -->
            <div class="docs-footer">
                <button class="action-btn" onclick="closeDocsModal()">关闭</button>
            </div>
        </div>
    </div>

    <!-- 沉浸式视频播放 Modal -->
    <div id="video-modal" class="modal">
        <div class="modal-content">
            <!-- 头部信息栏 -->
            <div class="video-modal-header">
                <div class="video-info">
                    <h3 id="video-modal-title">视频标题</h3>
                    <p id="video-modal-desc">视频简介...</p>
                </div>
                <span class="close-modal" onclick="closeVideoModal()">&times;</span>
            </div>

            <!-- 播放器主体 -->
            <div class="video-player-wrapper">
                <video id="example-video-player" controls autoplay>
                    <source src="" type="video/mp4">
                    您的浏览器不支持视频标签。
                </video>
            </div>
        </div>
    </div>

    <!-- index.html -->

    <footer>
        <div class="footer-content">
            <!-- 品牌介绍 -->
            <div class="footer-brand">
                <h3>
                    <img src="assets/智算视界_avatar.svg" alt="Logo" width="32">
                    智算视界
                </h3>
                <p>基于 AI 视觉识别与 Manim 动态引擎的下一代数学可视化计算平台。致力于降低数学学习门槛，让抽象公式触手可及。</p>
                <div class="social-links">
                    <a href="https://github.com/rainbowyuyu/Wisdom_Computing_Perspective" target="_blank" class="social-link" title="GitHub"><i class="fa-brands fa-github"></i></a>
                    <a href="https://www.bilibili.com/video/BV1n3dGYJEEJ/" target="_blank" class="social-link" title="Bilibili"><i class="fa-brands fa-bilibili"></i></a>
                    <a href="mailto:rainbowyu619@gmail.com" class="social-link" title="Email"><i class="fa-solid fa-envelope"></i></a>
                </div>
            </div>

            <!-- 链接列 1 -->
            <div class="footer-column">
                <h4>产品功能</h4>
                <ul>
                    <li><a href="#" onclick="showSection('detect')">智能识别</a></li>
                    <li><a href="#" onclick="showSection('calculate')">动态计算</a></li>
                    <li><a href="#" onclick="showSection('examples')">教学案例库</a></li>
                    <li><a href="#" onclick="startTutorial()">新手引导</a></li>
                </ul>
            </div>

            <!-- 链接列 2 -->
            <div class="footer-column">
                <h4>资源支持</h4>
                <ul>
                    <li><a href="javascript:void(0)" onclick="showSection('help')">使用文档</a></li>
                    <li><a href="javascript:void(0)" onclick="openDoc('api_doc.md', 'API 文档')">API 文档</a></li>
                    <li><a href="javascript:void(0)" onclick="openDoc('terms.md', '服务协议')">服务协议</a></li>
                    <li><a href="javascript:void(0)" onclick="openDoc('update.md', '更新日志')">更新日志</a></li>
                </ul>
            </div>

            <!-- 链接列 3 -->
            <div class="footer-column">
                <h4>关于我们</h4>
                <ul>
                    <li><a href="https://github.com/rainbowyuyu/Wisdom_Computing_Perspective" target="_blank">项目背景</a></li>
                    <li><a href="https://github.com/rainbowyuyu/Wisdom_Computing_Perspective" target="_blank">加入我们</a></li>
                    <li><a href="https://github.com/rainbowyuyu/Wisdom_Computing_Perspective" target="_blank">联系合作</a></li>
                    <li><a href="javascript:void(0)" onclick="openDoc('privacy.md', '隐私政策')">隐私政策</a></li>
                </ul>
            </div>

            <!-- 链接列 4：开发者工具 -->
            <div class="footer-column">
                <h4>开发者工具</h4>
                <ul>
                    <!-- 跳转并自动切换到 LaTeX 标签 -->
                    <li><a href="javascript:void(0)" onclick="showSection('devtools'); switchDevTool('latex')">LaTeX 编辑器</a></li>
                    <!-- 跳转并自动切换到 Manim 标签 -->
                    <li><a href="javascript:void(0)" onclick="showSection('devtools'); switchDevTool('manim')">Manim 工作台</a></li>
                </ul>
            </div>
        </div>

        <div class="footer-bottom">
            <p>© 2026 智算视界 (Wisdom Computing Perspective) · All rights reserved.</p>
            <p>
                Author: <a href="https://github.com/rainbowyuyu" target="_blank" style="color:#94a3b8; text-decoration:none;">rainbow_yu</a> |
                <a href="https://beian.miit.gov.cn/" target="_blank" style="color:#94a3b8; text-decoration:none;">沪ICP备2025156088号-2</a>
            </p>
        </div>
    </footer>

    <!-- 模块化 JS 入口 -->
    <script type="module" src="js/main.js"></script>
</body>
</html>